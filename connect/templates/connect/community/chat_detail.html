{% extends 'connect/community/base_community.html' %}
{% load static %}

{% block community_content %}
<div class="chat-detail-container">
    {% with other_participant=chat.participants.exclude.id=request.user.id.first %}
    <div class="chat-header card mb-3">
        <div class="card-body d-flex align-items-center">
            <a href="{% url 'connect:chat_list' %}" class="btn btn-light me-3">
                <i class="bi bi-arrow-left"></i>
            </a>
            
            <img src="{{ other_participant.profile.profile_picture.url|default:'default_profile.jpg' }}"
                 alt="{{ other_participant.username }}"
                 class="rounded-circle me-3"
                 style="width: 40px; height: 40px; object-fit: cover;">
            
            <div>
                <h5 class="mb-0">
                    {{ other_participant.get_full_name|default:other_participant.username }}
                </h5>
                <small class="text-muted">
                    {% if other_participant.is_online %}
                        <span class="text-success">
                            <i class="bi bi-circle-fill"></i> Online
                        </span>
                    {% else %}
                        Last seen {{ other_participant.last_login|timesince }} ago
                    {% endif %}
                </small>
            </div>
        </div>
    </div>
    {% endwith %}

    <div class="chat-messages card mb-3">
        <div class="card-body" id="messages-container">
            {% for message in messages reversed %}
                <div class="message {% if message.sender == request.user %}message-sent{% else %}message-received{% endif %} mb-3">
                    <div class="message-content">
                        {{ message.content }}
                        <small class="message-time">
                            {{ message.timestamp|time:"g:i A" }}
                        </small>
                    </div>
                </div>
            {% empty %}
                <div class="text-center py-5">
                    <i class="bi bi-chat-dots display-1 text-muted"></i>
                    <h5 class="mt-3">No Messages Yet</h5>
                    <p class="text-muted">Start the conversation!</p>
                </div>
            {% endfor %}
        </div>
    </div>

    <div class="chat-input card">
        <div class="card-body">
            <form id="message-form" class="d-flex gap-2">
                {% csrf_token %}
                <input type="text" id="message-input" class="form-control" 
                       placeholder="Type your message..." required>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-send"></i>
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    .chat-detail-container {
        height: calc(100vh - 200px);
        display: flex;
        flex-direction: column;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
    }

    #messages-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .message {
        max-width: 70%;
        display: flex;
    }

    .message-sent {
        align-self: flex-end;
    }

    .message-received {
        align-self: flex-start;
    }

    .message-content {
        padding: 0.75rem 1rem;
        border-radius: 1rem;
        position: relative;
    }

    .message-sent .message-content {
        background-color: var(--primary);
        color: white;
        border-bottom-right-radius: 0.25rem;
    }

    .message-received .message-content {
        background-color: #f0f2f5;
        border-bottom-left-radius: 0.25rem;
    }

    .message-time {
        display: block;
        font-size: 0.75rem;
        margin-top: 0.25rem;
        opacity: 0.8;
    }

    .chat-input {
        margin-top: auto;
    }

    #message-form {
        position: relative;
    }

    #message-input {
        padding-right: 4rem;
    }

    .btn-send {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
    }
</style>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
    const messagesContainer = document.getElementById('messages-container');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');

    // Scroll to bottom of messages
    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    scrollToBottom();

    // Handle message submission
    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const content = messageInput.value.trim();
        if (!content) return;

        fetch('{% url "connect:chat_detail" chat_id=chat.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                content: content
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Clear input
                messageInput.value = '';
                
                // Add message to UI
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message message-sent mb-3';
                messageDiv.innerHTML = `
                    <div class="message-content">
                        ${data.message.content}
                        <small class="message-time">${data.message.time}</small>
                    </div>
                `;
                messagesContainer.appendChild(messageDiv);
                scrollToBottom();
            }
        });
    });

    // Real-time updates using WebSocket (if implemented)
    try {
        const chatSocket = new WebSocket(
            'ws://' + window.location.host + 
            '/ws/chat/' + '{{ chat.id }}/'
        );

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if (data.sender_id !== {{ request.user.id }}) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message message-received mb-3';
                messageDiv.innerHTML = `
                    <div class="message-content">
                        ${data.message}
                        <small class="message-time">${data.time}</small>
                    </div>
                `;
                messagesContainer.appendChild(messageDiv);
                scrollToBottom();
            }
        };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };
    } catch (error) {
        console.error('WebSocket connection failed:', error);
    }
</script>
{% endblock %} 