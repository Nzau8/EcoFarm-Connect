{% extends 'connect/base.html' %}
{% block content %}
<div class="container mt-4">
  <h3>Negotiation Chat</h3>
  <div class="card">
    <!-- Product Details -->
    <div class="card-header bg-success text-white">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h5 class="mb-0">{{ product.name }}</h5>
          <small>Price: {{ product.price }} per unit</small>
        </div>
        <a href="{% url 'connect:productdetails' product.id %}" class="btn btn-light btn-sm">View Product</a>
      </div>
    </div>

    <!-- Chat Body -->
    <div class="card-body chatbox-body" id="negotiationChatBody" style="height: 400px; overflow-y: auto;">
      <ul id="messageList" class="list-unstyled">
        {% for message in messages %}
        <li class="mb-2 {% if message.sender == request.user %}text-end{% else %}text-start{% endif %}">
          <div class="chat-message {% if message.sender == request.user %}sent{% else %}received{% endif %}">
            <small class="text-muted">{{ message.sender.username }}</small>
            <div class="message-content">{{ message.content }}</div>
            <small class="text-muted">{{ message.timestamp|date:"g:i A" }}</small>
          </div>
        </li>
        {% endfor %}
      </ul>
    </div>

    <!-- Chat Input -->
    <div class="card-footer">
      <form id="chatForm" method="post" action="{% url 'connect:send_negotiation_message' chat.id %}">
        {% csrf_token %}
        <div class="input-group">
          <input type="text" name="message" class="form-control" placeholder="Type your message..." required>
          <button type="submit" class="btn btn-success">Send</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // WebSocket setup
  const chatSocket = new WebSocket(
    'ws://' + window.location.host + '/ws/chat/{{ chat.id }}/'
  );

  chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    // Add message to chat
    const messageList = document.getElementById('messageList');
    const li = document.createElement('li');
    li.className = `mb-2 ${data.sender === '{{ request.user.username }}' ? 'text-end' : 'text-start'}`;
    li.innerHTML = `
      <div class="chat-message ${data.sender === '{{ request.user.username }}' ? 'sent' : 'received'}">
        <small class="text-muted">${data.sender}</small>
        <div class="message-content">${data.message}</div>
        <small class="text-muted">${data.timestamp}</small>
      </div>
    `;
    messageList.appendChild(li);
    
    // Scroll to bottom
    const chatBody = document.getElementById('negotiationChatBody');
    chatBody.scrollTop = chatBody.scrollHeight;
  };

  chatSocket.onclose = function(e) {
    console.error('Negotiation chat socket closed unexpectedly');
  };
</script>
{% endblock %}
