{% extends "connect/base.html" %}

{% block content %}
<div class="container mt-4">
  <h3>Manage Your Orders</h3>
  <p>View and manage orders for your products.</p>

  <!-- Orders by Status -->
  <div class="accordion" id="ordersAccordion">

    <!-- Pending Orders -->
    <div class="card">
      <div class="card-header" id="pendingOrdersHeading">
        <h5 class="mb-0">
          <button class="btn btn-link text-dark" type="button" data-bs-toggle="collapse" data-bs-target="#pendingOrders" aria-expanded="true" aria-controls="pendingOrders">
            Pending Orders ({{ pending_orders|length }})
          </button>
        </h5>
      </div>
      <div id="pendingOrders" class="collapse show" aria-labelledby="pendingOrdersHeading" data-parent="#ordersAccordion">
        <div class="card-body">
          {% if pending_orders %}
          <table class="table">
            <thead>
              <tr>
                <th>#</th>
                <th>Buyer</th>
                <th>Product</th>
                <th>Quantity</th>
                <th>Total</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for order in pending_orders %}
              <tr>
                <td>{{ order.id }}</td>
                <td>{{ order.buyer.username }}</td>
                <td>{{ order.product.name }}</td>
                <td>{{ order.quantity }}</td>
                <td>KES {{ order.total_price }}</td>
                <td>{{ order.created_at|date:"M d, Y" }}</td>
                <td>
                  <a href="{% url 'connect:seller_order_detail' order.id %}" class="btn btn-sm btn-info">Details</a>
                  <button class="btn btn-sm btn-success" onclick="acceptOrder({{ order.id }})">Accept</button>
                  <button class="btn btn-sm btn-danger" onclick="rejectOrder({{ order.id }})">Reject</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <p>No pending orders.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Return to Dashboard -->
  <div class="mt-4">
    <a href="{% url 'connect:sellerdashboard' %}" class="btn btn-outline-secondary">Back to Dashboard</a>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function acceptOrder(orderId) {
  if (confirm('Are you sure you want to accept this order?')) {
    fetch(`{% url 'connect:accept_order' %}${orderId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      }
    });
  }
}

function rejectOrder(orderId) {
  if (confirm('Are you sure you want to reject this order?')) {
    fetch(`{% url 'connect:reject_order' %}${orderId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      }
    });
  }
}
</script>
{% endblock %}
