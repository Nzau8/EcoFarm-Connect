{% extends 'connect/base.html' %}
{% load static %}

{% block title %}Create Discussion - Connect{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h1 class="card-title mb-4">Start a New Discussion</h1>
                    
                    <form method="post" action="{% url 'connect:creatediscussion' %}" id="discussionForm">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <div class="mb-3">
                            <label for="{{ form.title.id_for_label }}" class="form-label">Title</label>
                            {{ form.title }}
                            {% if form.title.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.title.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                            {{ form.description }}
                            {% if form.description.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.description.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.tags.id_for_label }}" class="form-label">Tags</label>
                            <div class="tag-selection-container">
                                <div class="input-group mb-3">
                                    <select class="form-select" id="tagDropdown">
                                        <option value="">Select a tag...</option>
                                        <!-- Options will be populated by JavaScript -->
                                    </select>
                                    <button class="btn btn-success" type="button" onclick="handleTagSelection()">
                                        <i class="fas fa-plus"></i> Add Tag
                                    </button>
                                    <button class="btn btn-outline-secondary" type="button" onclick="clearTagSelection()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>

                                <!-- Hidden select field that will be populated by JavaScript -->
                                {{ form.tags.as_hidden }}
                                
                                <!-- Selected Tags Display -->
                                <div id="selected-tags" class="mt-2">
                                    <!-- Selected tags will be displayed here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hidden input for tags -->
                        <input type="hidden" name="tags" id="tagsList" value="">

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Create Discussion</button>
                            <a href="{% url 'connect:communityhome' %}" class="btn btn-outline-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const predefinedTags = [
    // Farming Methods & Techniques
    'TraditionalFarming',
    'OrganicFarming',
    'HydroponicFarming',
    'AquaponicFarming',
    'VerticalFarming',
    'GreenhouseFarming',
    'ContainerGardening',
    'NoTillFarming',
    'Permaculture',
    'BiodynamicFarming',
    'IntercropFarming',
    'CropRotation',
    'Agroforestry',
    'IntegratedFarming',
    'PrecisionFarming',
    
    // Sustainable Practices
    'SustainableFarming',
    'ClimateSmartAgriculture',
    'WaterConservation',
    'SoilConservation',
    'RainwaterHarvesting',
    'CompostTechniques',
    'OrganicPestControl',
    'NaturalFertilizers',
    'BiodiversityManagement',
    'WasteManagement',
    
    // Livestock & Animal Husbandry
    'LivestockFarming',
    'PoultryFarming',
    'DairyFarming',
    'CattleRearing',
    'GoatFarming',
    'SheepFarming',
    'FishFarming',
    'Beekeeping',
    'AnimalWelfare',
    'FodderManagement',
    
    // Crop Management
    'CropProtection',
    'PestManagement',
    'DiseaseControl',
    'WeedManagement',
    'SeedSelection',
    'PlantNutrition',
    'IrrigationMethods',
    'HarvestingTechniques',
    'PostHarvestHandling',
    'StorageSolutions',
    
    // Technology & Innovation
    'AgriTech',
    'SmartFarming',
    'DroneApplications',
    'IoTinAgriculture',
    'AutomatedIrrigation',
    'SensorTechnology',
    'FarmManagementSoftware',
    'WeatherMonitoring',
    'SoilTesting',
    'GPSMapping',
    
    // Business & Marketing
    'AgriBusiness',
    'FarmManagement',
    'MarketAccess',
    'ValueAddition',
    'SupplyChain',
    'Certification',
    'OrganicCertification',
    'FairTrade',
    'DirectMarketing',
    'ExportMarkets',
    
    // Community & Education
    'FarmingCommunity',
    'KnowledgeSharing',
    'FarmerTraining',
    'YouthInAgriculture',
    'WomenInAgriculture',
    'FarmerCooperatives',
    'RuralDevelopment',
    'AgriExtension',
    'SkillDevelopment',
    'BestPractices'
];

// Group tags for the dropdown
const tagGroups = {
    'Farming Methods & Techniques': predefinedTags.slice(0, 15),
    'Sustainable Practices': predefinedTags.slice(15, 25),
    'Livestock & Animal Husbandry': predefinedTags.slice(25, 35),
    'Crop Management': predefinedTags.slice(35, 45),
    'Technology & Innovation': predefinedTags.slice(45, 55),
    'Business & Marketing': predefinedTags.slice(55, 65),
    'Community & Education': predefinedTags.slice(65)
};

function handleTagSelection() {
    const dropdown = document.getElementById('tagDropdown');
    const tagValue = dropdown.value;
    if (!tagValue) return;  // Skip if no tag selected
    
    const tagSelect = document.getElementById('{{ form.tags.id_for_label }}');
    
    // Check if tag is already selected
    if (!Array.from(tagSelect.options).some(opt => opt.value === tagValue)) {
        // Add tag
        const option = new Option(tagValue, tagValue, true, true);
        tagSelect.add(option);
        
        // Create and add tag badge
        const selectedTagsDiv = document.getElementById('selected-tags');
        const tagSpan = document.createElement('span');
        tagSpan.className = 'badge bg-success me-2 mb-2';
        tagSpan.innerHTML = `
            #${tagValue}
            <button type="button" class="btn-close btn-close-white ms-2" 
                    onclick="removeTag('${tagValue}')" 
                    aria-label="Remove tag"></button>
        `;
        selectedTagsDiv.appendChild(tagSpan);
        
        // Add animation class
        tagSpan.classList.add('tag-appear');
    }
    
    // Reset dropdown to placeholder
    dropdown.value = '';
}

function removeTag(tagValue) {
    const tagSelect = document.getElementById('{{ form.tags.id_for_label }}');
    const selectedTagsDiv = document.getElementById('selected-tags');
    
    // Remove from hidden select
    Array.from(tagSelect.options).forEach(option => {
        if (option.value === tagValue) {
            tagSelect.remove(option.index);
        }
    });
    
    // Remove badge with animation
    const tagBadge = Array.from(selectedTagsDiv.children).find(
        badge => badge.textContent.trim().slice(1) === tagValue
    );
    if (tagBadge) {
        tagBadge.classList.add('tag-remove');
        setTimeout(() => tagBadge.remove(), 300);
    }
}

function clearTagSelection() {
    const tagSelect = document.getElementById('{{ form.tags.id_for_label }}');
    tagSelect.innerHTML = '';
    updateSelectedTags();
}

// Initialize when the page loads
document.addEventListener('DOMContentLoaded', function() {
    const dropdown = document.getElementById('tagDropdown');
    dropdown.innerHTML = '<option value="">Select a tag...</option>';
    
    // Add grouped options
    for (const [group, tags] of Object.entries(tagGroups)) {
        const optgroup = document.createElement('optgroup');
        optgroup.label = group;
        
        tags.forEach(tag => {
            const option = new Option(tag, tag);  // Removed the # from display text
            optgroup.appendChild(option);
        });
        
        dropdown.appendChild(optgroup);
    }
    
    // Initialize selected tags display
    updateSelectedTags();
});
</script>
{% endblock %}

{% block extra_css %}
<style>
.tag-selection-container {
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    padding: 1rem;
}

.form-select {
    cursor: pointer;
}

.form-select option {
    padding: 8px 12px;
    cursor: pointer;
}

.form-select option:hover {
    background-color: #f8f9fa;
}

.form-select optgroup {
    font-weight: bold;
    color: #6c757d;
    padding: 8px 0;
}

.badge {
    font-size: 0.9rem;
    padding: 0.5rem 0.75rem;
    background-color: #28a745;
    transition: all 0.3s ease;
}

.btn-close {
    font-size: 0.7rem;
    padding: 0.25rem;
    opacity: 0.8;
}

.btn-close:hover {
    opacity: 1;
}

#selected-tags {
    min-height: 38px;
    padding: 0.375rem 0;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
    border-top: 1px solid #dee2e6;
    padding-top: 1rem;
}

.badge button {
    border: none;
    background: none;
    padding: 0;
    margin-left: 0.5rem;
    cursor: pointer;
}

/* Add animation for tag selection */
.badge {
    animation: tagAppear 0.3s ease-in-out;
}

@keyframes tagAppear {
    from {
        transform: scale(0.8);
        opacity: 0;
    }
    to {
        transform: scale(1);
        opacity: 1;
    }
}

.btn-success {
    margin-left: 5px;
}

.input-group .btn {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.input-group .btn i {
    font-size: 0.875rem;
}

.tag-appear {
    animation: tagAppear 0.3s ease-in-out;
}

.tag-remove {
    animation: tagRemove 0.3s ease-in-out;
}

@keyframes tagAppear {
    from {
        transform: scale(0.8);
        opacity: 0;
    }
    to {
        transform: scale(1);
        opacity: 1;
    }
}

@keyframes tagRemove {
    from {
        transform: scale(1);
        opacity: 1;
    }
    to {
        transform: scale(0.8);
        opacity: 0;
    }
}

.badge .btn-close {
    padding: 0.25rem;
    margin-left: 0.5rem;
    font-size: 0.7rem;
    opacity: 0.8;
    transition: opacity 0.2s;
}

.badge .btn-close:hover {
    opacity: 1;
}
</style>
{% endblock %}
