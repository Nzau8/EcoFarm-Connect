{% extends 'connect/base.html' %}
{% load static %}

{% block title %}Order Confirmation - Connect{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body text-center">
                    <h2 class="card-title text-success">
                        <i class="fas fa-check-circle"></i> Order Confirmed!
                    </h2>
                    <p class="lead">Thank you for your order!</p>
                    <h4>Order #{{ order.id }}</h4>
                    
                    <div class="order-details mt-4">
                        <div class="row">
                            <div class="col-md-6 text-md-right">
                                <p><strong>Order Date:</strong></p>
                                <p><strong>Total Amount:</strong></p>
                                <p><strong>Delivery Address:</strong></p>
                                <p><strong>Contact Number:</strong></p>
                                <p><strong>Status:</strong></p>
                                {% if order.get_primary_seller %}
                                <p><strong>Seller:</strong></p>
                                {% endif %}
                            </div>
                            <div class="col-md-6 text-md-left">
                                <p>{{ order.created_at|date:"F d, Y" }}</p>
                                <p>KES {{ order.total_price }}</p>
                                <p>{{ order.delivery_address }}</p>
                                <p>{{ order.contact_number }}</p>
                                <p>{{ order.status }}</p>
                                {% if order.get_primary_seller %}
                                <p>{{ order.get_primary_seller.company_name }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="order-items mt-4">
                        <h5>Order Items</h5>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in order.orderitem_set.all %}
                                <tr>
                                    <td>{{ item.product.name }}</td>
                                    <td>{{ item.quantity }} {{ item.product.unit }}</td>
                                    <td>KES {{ item.product.price }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Payment Section -->
                    {% if order.payment_status == 'PENDING' %}
                    <div class="payment-section mt-4">
                        <h5>Payment</h5>
                        <div class="alert alert-info">
                            <p>Please complete your payment to process your order.</p>
                            <p class="mb-2">Total Amount: <strong>KES {{ order.total_price }}</strong></p>
                            
                            <!-- M-Pesa Payment Form -->
                            <form id="mpesa-payment-form" class="mt-3">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label for="phone_number" class="form-label">M-Pesa Phone Number</label>
                                    <input type="tel" class="form-control" id="phone_number" 
                                           placeholder="e.g., 254712345678" required
                                           pattern="^254[0-9]{9}$">
                                    <small class="text-muted">Format: 254XXXXXXXXX</small>
                                </div>
                                <button type="submit" class="btn btn-success" id="pay-button">
                                    Pay with M-Pesa
                                </button>
                            </form>
                        </div>
                    </div>
                    {% endif %}

                    {% if order.assigned_rider %}
                    <div class="delivery-info mt-4">
                        <h5>Delivery Information</h5>
                        <p>Rider: {{ order.assigned_rider.user.username }}</p>
                        <p>Status: {{ order.delivery_status }}</p>
                    </div>
                    {% endif %}

                    <div class="mt-4">
                        <a href="{% url 'connect:marketplacehome' %}" class="btn btn-primary">
                            Continue Shopping
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const orderId = {{ order.id|default:0 }};  // Get order ID from template

document.getElementById('mpesa-payment-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const phoneNumber = document.getElementById('phone_number').value;
    const payButton = document.getElementById('pay-button');
    const amount = parseFloat('{{ order.total_price|default:0 }}');
    
    // Disable button and show loading state
    payButton.disabled = true;
    payButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
    
    // Make payment request
    fetch('{% url "connect:initiate_payment" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            phone_number: phoneNumber,
            amount: amount,
            order_id: orderId  // Use the orderId variable
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Show success message
            alert('Please check your phone for the M-Pesa prompt');
            
            // Start polling for payment status
            checkPaymentStatus();
        } else {
            // Show error message
            alert(data.message);
            
            // Reset button state
            payButton.disabled = false;
            payButton.innerHTML = 'Pay with M-Pesa';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
        
        // Reset button state
        payButton.disabled = false;
        payButton.innerHTML = 'Pay with M-Pesa';
    });
});

function checkPaymentStatus() {
    // Poll payment status every 5 seconds
    const statusCheck = setInterval(() => {
        fetch(`/order/${orderId}/payment-status/`)  // Use orderId here
            .then(response => response.json())
            .then(data => {
                if (data.status === 'COMPLETED') {
                    clearInterval(statusCheck);
                    window.location.reload();
                } else if (data.status === 'FAILED') {
                    clearInterval(statusCheck);
                    alert('Payment failed. Please try again.');
                    window.location.reload();
                }
            });
    }, 5000);
}
</script>
{% endblock %}
